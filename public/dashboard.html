<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Dashboard - 2FA App</title>
    <link rel="stylesheet" href="/css/style.css" />
  </head>
  <body>
    <div class="card" style="max-width: 500px">
      <div class="user-info">
        <div>
          <h1>üõ°Ô∏è Dashboard</h1>
          <p class="subtitle" style="margin-bottom: 0">Manage your security</p>
        </div>
        <div class="user-badge" id="userBadge">Loading...</div>
      </div>

      <div id="message" class="message"></div>

      <div class="status-card">
        <div class="status-header">
          <div class="status-icon" id="statusIcon"></div>
          <div>
            <h3 class="status-title">Security Status</h3>
            <p class="status-text" id="statusText">Loading...</p>
          </div>
        </div>
        <p class="status-description" id="statusDescription">
          Checking your security status...
        </p>
      </div>

      <div class="btn-group">
        <button id="actionBtn" class="btn btn-primary" style="display: none">
          Enable 2FA
        </button>
        <button id="logoutBtn" class="btn btn-danger">Log Out</button>
      </div>
    </div>

    <script src="/js/app.js"></script>
    <script>
      async function init() {
        const user = await protectPage();
        if (user) loadDashboard(user);
      }

      async function loadDashboard(user) {
        try {
          // data already provided by init()

          document.getElementById("userBadge").textContent = user.username;

          const statusIcon = document.getElementById("statusIcon");
          const statusText = document.getElementById("statusText");
          const statusDescription =
            document.getElementById("statusDescription");
          const actionBtn = document.getElementById("actionBtn");

          if (user.isMfaActive) {
            statusIcon.className = "status-icon active";
            statusIcon.innerHTML = "üõ°Ô∏è";
            statusText.textContent = "2FA Active";
            statusText.className = "status-text active";
            statusDescription.textContent =
              "Your account is protected with two-factor authentication.";

            actionBtn.textContent = "Reset 2FA";
            actionBtn.className = "btn btn-danger";
            actionBtn.style.display = "block";
            actionBtn.onclick = handleReset;
          } else {
            statusIcon.className = "status-icon inactive";
            statusIcon.innerHTML = "‚ö†Ô∏è";
            statusText.textContent = "2FA Disabled";
            statusText.className = "status-text inactive";
            statusDescription.textContent =
              "Enable two-factor authentication for extra security.";

            actionBtn.textContent = "Enable 2FA";
            actionBtn.className = "btn btn-success";
            actionBtn.style.display = "block";
            actionBtn.onclick = () => goTo("/setup-2fa.html");
          }
        } catch (error) {
          showMessage("error", "Session expired. Please login again.");
          setTimeout(() => {
            clearTokens();
            goTo("/");
          }, 2000);
        }
      }

      async function handleReset() {
        const code = prompt(
          "Please enter your 6-digit 2FA code to confirm reset:",
        );
        if (!code) return;

        try {
          await reset2FA(code);
          showMessage("success", "2FA has been disabled!");
          loadDashboard();
        } catch (error) {
          showMessage("error", error.message);
        }
      }

      document.getElementById("logoutBtn").onclick = logout;

      init();
    </script>
  </body>
</html>
